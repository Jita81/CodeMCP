<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursor Background Agent Configuration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: #f8fafc;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .model-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .model-controls select {
            flex: 1;
        }

        .update-models-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .update-models-btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .update-models-btn:active {
            transform: translateY(0);
        }

        .update-models-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .repository-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .repository-controls input {
            flex: 1;
        }

        .update-repos-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .update-repos-btn:hover {
            background: linear-gradient(135deg, #0056b3, #007bff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .update-repos-btn:active {
            transform: translateY(0);
        }

        .update-repos-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .repository-dropdown {
            margin-top: 10px;
        }

        .repository-dropdown select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }

        .branch-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .branch-controls input {
            flex: 1;
        }

        .update-branches-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .update-branches-btn:hover {
            background: linear-gradient(135deg, #20c997, #28a745);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .update-branches-btn:active {
            transform: translateY(0);
        }

        .update-branches-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .branch-dropdown {
            margin-top: 10px;
        }

        .branch-dropdown select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }

        .branch-options {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        #newBranchName {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 8px;
        }

        .model-info {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #1a365d;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 500;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .config-preview {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .help-text {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
            font-style: italic;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .feature-card h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .feature-card p {
            color: #718096;
            font-size: 0.9rem;
        }

        /* View Toggle Styles */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .toggle-btn {
            padding: 12px 24px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: #f8f9fa;
        }

        .toggle-btn.active {
            background: #007bff;
            color: white;
        }

        /* Agent Management Styles */
        .agent-management {
            display: block;
        }

        /* Create Agent Form - Hidden by default */
        #configForm {
            display: none;
        }

        .agent-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }

        .agent-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .agent-id {
            font-family: monospace;
            font-size: 14px;
            color: #666;
            background: #f1f3f4;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .agent-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-running { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-stopped { background: #e2e3e5; color: #383d41; }
        .status-creating { background: #fff3cd; color: #856404; }

        .agent-details {
            margin: 10px 0;
        }

        .agent-detail-row {
            display: flex;
            margin: 5px 0;
        }

        .agent-detail-label {
            font-weight: bold;
            min-width: 120px;
            color: #555;
        }

        .agent-detail-value {
            color: #333;
            word-break: break-all;
        }

        .agent-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-small:hover {
            background: #f8f9fa;
        }

        .btn-primary { border-color: #007bff; color: #007bff; }
        .btn-danger { border-color: #dc3545; color: #dc3545; }
        .btn-success { border-color: #28a745; color: #28a745; }

        .loading-agents {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-agents {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Cursor Agent Manager</h1>
            <p>Create new agents or manage existing background agents</p>
            
            <!-- View Toggle -->
            <div class="view-toggle">
                <button id="createViewBtn" class="toggle-btn" onclick="switchView('create')">
                    ‚ûï Create New Agent
                </button>
                <button id="manageViewBtn" class="toggle-btn active" onclick="switchView('manage')">
                    üìã Manage Existing Agents
                </button>
            </div>
        </div>

        <form id="configForm">
            <div class="form-group">
                <label for="repository_url">üìÇ Repository URL</label>
                <div class="repository-controls">
                    <input 
                        type="url" 
                        id="repository_url" 
                        name="repository_url" 
                        placeholder="https://github.com/username/repository"
                        required
                    >
                    <button type="button" id="updateRepositories" class="update-repos-btn" onclick="updateAvailableRepositories()">
                        üîÑ Update Repos
                    </button>
                </div>
                <div class="help-text">Enter the GitHub repository URL or select from your accessible repositories</div>
                <div class="repository-dropdown" id="repositoryDropdown" style="display: none;">
                    <select id="repositorySelect" onchange="selectRepository()">
                        <option value="">Select a repository...</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="model">üß† AI Model</label>
                    <div class="model-controls">
                        <select id="model" name="model" required>
                            <option value="claude-4-sonnet-thinking" selected>Claude 4 Sonnet Thinking (Recommended)</option>
                            <option value="o3">O3 (Advanced Reasoning)</option>
                            <option value="claude-4-opus-thinking">Claude 4 Opus Thinking (Most Capable)</option>
                        </select>
                        <button type="button" id="updateModels" class="update-models-btn" onclick="updateAvailableModels()">
                            üîÑ Update Models
                        </button>
                    </div>
                    <div class="model-info" id="modelInfo">
                        <strong>Claude 3.5 Sonnet:</strong> Best overall performance with good balance of speed, cost, and capability. Recommended for most tasks.
                    </div>
                </div>

                <div class="form-group">
                    <label for="branch">üåø Target Branch</label>
                    <div class="branch-controls">
                        <input 
                            type="text" 
                            id="branch" 
                            name="branch" 
                            placeholder="main"
                            value="main"
                            required
                        >
                        <button type="button" id="updateBranches" class="update-branches-btn" onclick="updateAvailableBranches()">
                            üîÑ Update Branches
                        </button>
                    </div>
                    <div class="help-text">Branch where the agent will make changes (e.g., feature/new-feature)</div>
                    <div class="branch-dropdown" id="branchDropdown" style="display: none;">
                        <select id="branchSelect" onchange="selectBranch()">
                            <option value="">Select a branch...</option>
                        </select>
                    </div>
                    <div class="branch-options">
                        <label class="checkbox-label">
                            <input type="checkbox" id="createNewBranch" onchange="toggleNewBranchInput()">
                            Create new branch
                        </label>
                        <input 
                            type="text" 
                            id="newBranchName" 
                            placeholder="Enter new branch name..."
                            style="display: none;"
                            oninput="updateBranchFromNewName()"
                        >
                    </div>
                </div>
            </div>


            <div class="form-group">
                <label for="prompt">üìù Task Description</label>
                <textarea 
                    id="prompt" 
                    name="prompt" 
                    placeholder="Describe what you want the AI agent to do..."
                    required
                ></textarea>
                <div class="help-text">Be specific about requirements, acceptance criteria, and any constraints</div>
            </div>

            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="previewConfig()">
                    üëÅÔ∏è Preview Config
                </button>
                <button type="submit" class="btn btn-primary">
                    üöÄ Create Agent
                </button>
            </div>
        </form>

        <!-- Agent Management Section -->
        <div class="agent-management" id="agentManagement">
            <div class="form-group">
                <button type="button" id="refreshAgents" class="btn" onclick="loadAgents()">
                    üîÑ Refresh Agents
                </button>
            </div>
            
            <div class="agent-list" id="agentList">
                <div class="loading-agents">
                    <p>Loading agents...</p>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>
        <div id="configPreview" class="config-preview" style="display: none;"></div>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>ü§ñ Autonomous Coding</h3>
                <p>AI agents work independently on your repositories</p>
            </div>
            <div class="feature-card">
                <h3>üìä Real-time Monitoring</h3>
                <p>Track progress and see files being modified</p>
            </div>
            <div class="feature-card">
                <h3>üîÑ Follow-up Instructions</h3>
                <p>Send additional guidance during execution</p>
            </div>
        </div>
    </div>

    <script>
        // Model information data
        const modelInfo = {
            'claude-4-sonnet-thinking': {
                name: 'Claude 4 Sonnet Thinking',
                description: 'Advanced reasoning with thinking mode. Best overall performance for complex coding tasks.',
                speed: 'Fast',
                cost: 'Moderate',
                capability: 'Very High'
            },
            'o3': {
                name: 'O3',
                description: 'Cutting-edge reasoning model with advanced problem-solving capabilities.',
                speed: 'Moderate',
                cost: 'High',
                capability: 'Exceptional'
            },
            'claude-4-opus-thinking': {
                name: 'Claude 4 Opus Thinking',
                description: 'Most capable model with deep reasoning and complex analysis abilities.',
                speed: 'Moderate',
                cost: 'High',
                capability: 'Maximum'
            }
        };


        // Update model info when selection changes
        document.getElementById('model').addEventListener('change', function() {
            const selectedModel = this.value;
            const info = modelInfo[selectedModel];
            const infoDiv = document.getElementById('modelInfo');
            
            infoDiv.innerHTML = `
                <strong>${info.name}:</strong> ${info.description}<br>
                <em>Speed: ${info.speed} | Cost: ${info.cost} | Capability: ${info.capability}</em>
            `;
        });

        // Set initial prompt
        document.getElementById('prompt').value = "Describe what you want the AI agent to accomplish in detail...";

        // View switching functionality
        function switchView(view) {
            const createView = document.getElementById('configForm');
            const manageView = document.getElementById('agentManagement');
            const createBtn = document.getElementById('createViewBtn');
            const manageBtn = document.getElementById('manageViewBtn');
            
            if (view === 'create') {
                createView.style.display = 'block';
                manageView.style.display = 'none';
                createBtn.classList.add('active');
                manageBtn.classList.remove('active');
            } else {
                createView.style.display = 'none';
                manageView.style.display = 'block';
                createBtn.classList.remove('active');
                manageBtn.classList.add('active');
                loadAgents(); // Load agents when switching to manage view
            }
        }

        // Load and display agents
        async function loadAgents() {
            const agentList = document.getElementById('agentList');
            const refreshBtn = document.getElementById('refreshAgents');
            
            try {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'üîÑ Loading...';
                agentList.innerHTML = '<div class="loading-agents"><p>Loading agents...</p></div>';
                
                const response = await fetch('/api/agents');
                const data = await response.json();
                
                if (data.success && data.agents && data.agents.length > 0) {
                    displayAgents(data.agents);
                    showStatus(`‚úÖ Loaded ${data.agents.length} agents`, 'success');
                } else {
                    agentList.innerHTML = '<div class="no-agents"><p>No agents found. Create your first agent!</p></div>';
                    showStatus('‚ÑπÔ∏è No agents found', 'info');
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                agentList.innerHTML = '<div class="no-agents"><p>Error loading agents. Please try again.</p></div>';
                showStatus('‚ùå Failed to load agents', 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'üîÑ Refresh Agents';
            }
        }

        // Display agents in the UI
        function displayAgents(agents) {
            const agentList = document.getElementById('agentList');
            
            agentList.innerHTML = agents.map(agent => {
                const status = agent.status || 'unknown';
                const statusClass = `status-${status.toLowerCase()}`;
                
                return `
                    <div class="agent-card">
                        <div class="agent-header">
                            <span class="agent-id">${agent.id || 'Unknown ID'}</span>
                            <span class="agent-status ${statusClass}">${status}</span>
                        </div>
                        
                        <div class="agent-details">
                            ${agent.name ? `<div class="agent-detail-row">
                                <span class="agent-detail-label">Name:</span>
                                <span class="agent-detail-value">${agent.name}</span>
                            </div>` : ''}
                            
                            ${agent.source ? `<div class="agent-detail-row">
                                <span class="agent-detail-label">Repository:</span>
                                <span class="agent-detail-value">${agent.source.repository || 'N/A'}</span>
                            </div>` : ''}
                            
                            ${agent.source ? `<div class="agent-detail-row">
                                <span class="agent-detail-label">Branch:</span>
                                <span class="agent-detail-value">${agent.source.ref || 'N/A'}</span>
                            </div>` : ''}
                            
                            ${agent.target ? `<div class="agent-detail-row">
                                <span class="agent-detail-label">Target Branch:</span>
                                <span class="agent-detail-value">${agent.target.branchName || 'N/A'}</span>
                            </div>` : ''}
                            
                            ${agent.summary ? `<div class="agent-detail-row">
                                <span class="agent-detail-label">Summary:</span>
                                <span class="agent-detail-value">${agent.summary}</span>
                            </div>` : ''}
                            
                            ${agent.createdAt ? `<div class="agent-detail-row">
                                <span class="agent-detail-label">Created:</span>
                                <span class="agent-detail-value">${new Date(agent.createdAt).toLocaleString()}</span>
                            </div>` : ''}
                        </div>
                        
                        <div class="agent-actions">
                            ${agent.target && agent.target.url ? `<button class="btn-small btn-primary" onclick="window.open('${agent.target.url}', '_blank')">View Agent</button>` : ''}
                            ${agent.target && agent.target.prUrl ? `<button class="btn-small btn-success" onclick="window.open('${agent.target.prUrl}', '_blank')">View PR</button>` : ''}
                            <button class="btn-small btn-danger" onclick="stopAgent('${agent.id}')">Stop Agent</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Stop an agent
        async function stopAgent(agentId) {
            if (!confirm('Are you sure you want to stop this agent?')) {
                return;
            }
            
            try {
                showStatus('Stopping agent...', 'success');
                
                // In a real implementation, this would call the MCP server
                // For now, we'll just show a message
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showStatus(`‚úÖ Agent ${agentId} stopped`, 'success');
                loadAgents(); // Refresh the list
            } catch (error) {
                console.error('Error stopping agent:', error);
                showStatus('‚ùå Failed to stop agent', 'error');
            }
        }

        function previewConfig() {
            const formData = new FormData(document.getElementById('configForm'));
            const config = Object.fromEntries(formData.entries());
            
            const configJson = {
                repository_url: config.repository_url,
                prompt: config.prompt,
                branch: config.branch,
                model: config.model,
                timestamp: new Date().toISOString()
            };

            const preview = document.getElementById('configPreview');
            preview.style.display = 'block';
            preview.innerHTML = `
                <strong>Generated Configuration:</strong><br><br>
                <pre>${JSON.stringify(configJson, null, 2)}</pre>
                <br>
                <strong>MCP Tool Call:</strong><br><br>
                <pre>cursor_create_background_agent(${JSON.stringify(configJson, null, 2)})</pre>
            `;

            // Scroll to preview
            preview.scrollIntoView({ behavior: 'smooth' });
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }

        // Update available models from Cursor API
        async function updateAvailableModels() {
            const updateBtn = document.getElementById('updateModels');
            const modelSelect = document.getElementById('model');
            const currentValue = modelSelect.value;
            
            try {
                // Disable button and show loading
                updateBtn.disabled = true;
                updateBtn.textContent = 'üîÑ Updating...';
                showStatus('Fetching available models from Cursor API...', 'success');
                
                // Fetch models from API with force refresh
                const response = await fetch('/api/models?force_refresh=true');
                const data = await response.json();
                
                if (data.success && data.models && data.models.length > 0) {
                    // Clear existing options
                    modelSelect.innerHTML = '';
                    
                    // Add fetched models
                    data.models.forEach((model, index) => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = formatModelName(model);
                        if (index === 0) option.selected = true; // Select first as default
                        modelSelect.appendChild(option);
                    });
                    
                    // Try to restore previous selection
                    if (currentValue && data.models.includes(currentValue)) {
                        modelSelect.value = currentValue;
                    }
                    
                    // Update model info
                    updateModelInfo();
                    
                    // Store data in localStorage for persistence
                    localStorage.setItem('lastLoadedModels', JSON.stringify(data.models));
                    localStorage.setItem('lastModelLoadTime', Date.now().toString());
                    
                    showStatus(`‚úÖ Updated! Found ${data.models.length} available models`, 'success');
                } else {
                    showStatus('‚ö†Ô∏è No models returned from API, using defaults', 'warning');
                }
                
            } catch (error) {
                console.error('Error fetching models:', error);
                showStatus('‚ùå Failed to fetch models from API', 'error');
            } finally {
                // Re-enable button
                updateBtn.disabled = false;
                updateBtn.textContent = 'üîÑ Update Models';
            }
        }

        // Format model name for display
        function formatModelName(model) {
            const nameMap = {
                'claude-4-sonnet-thinking': 'Claude 4 Sonnet Thinking (Recommended)',
                'o3': 'O3 (Advanced Reasoning)',
                'claude-4-opus-thinking': 'Claude 4 Opus Thinking (Most Capable)'
            };
            return nameMap[model] || model.charAt(0).toUpperCase() + model.slice(1).replace(/-/g, ' ');
        }

        // Update model information display
        function updateModelInfo() {
            const modelSelect = document.getElementById('model');
            const modelInfoDiv = document.getElementById('modelInfo');
            const selectedModel = modelSelect.value;
            
            // Store selected model in localStorage
            if (selectedModel) {
                localStorage.setItem('selectedModel', selectedModel);
            }
            
            if (modelInfo[selectedModel]) {
                const info = modelInfo[selectedModel];
                modelInfoDiv.innerHTML = `
                    <strong>${info.name}:</strong> ${info.description}
                    <br><em>Speed: ${info.speed} | Cost: ${info.cost} | Capability: ${info.capability}</em>
                `;
            } else {
                modelInfoDiv.innerHTML = `<strong>${formatModelName(selectedModel)}:</strong> Advanced AI model for autonomous coding tasks.`;
            }
        }

        // Update available repositories from Cursor API
        async function updateAvailableRepositories() {
            const updateBtn = document.getElementById('updateRepositories');
            const repositoryDropdown = document.getElementById('repositoryDropdown');
            const repositorySelect = document.getElementById('repositorySelect');
            const repositoryInput = document.getElementById('repository_url');
            
            try {
                // Disable button and show loading
                updateBtn.disabled = true;
                updateBtn.textContent = 'üîÑ Updating...';
                showStatus('Fetching accessible repositories from Cursor API...', 'success');
                
                // Fetch repositories from API with force refresh
                const response = await fetch('/api/repositories?force_refresh=true');
                const data = await response.json();
                
                if (data.success && data.repositories && data.repositories.length > 0) {
                    // Clear existing options
                    repositorySelect.innerHTML = '<option value="">Select a repository...</option>';
                    
                    // Add fetched repositories
                    data.repositories.forEach((repo) => {
                        const option = document.createElement('option');
                        option.value = repo.repository;
                        option.textContent = `${repo.owner}/${repo.name}`;
                        repositorySelect.appendChild(option);
                    });
                    
                    // Show dropdown
                    repositoryDropdown.style.display = 'block';
                    
                    // Store data in localStorage for persistence
                    localStorage.setItem('lastLoadedRepositories', JSON.stringify(data.repositories));
                    localStorage.setItem('lastRepositoryLoadTime', Date.now().toString());
                    
                    showStatus(`‚úÖ Updated! Found ${data.repositories.length} accessible repositories`, 'success');
                } else {
                    showStatus('‚ö†Ô∏è No repositories returned from API', 'warning');
                }
                
            } catch (error) {
                console.error('Error fetching repositories:', error);
                showStatus('‚ùå Failed to fetch repositories from API', 'error');
            } finally {
                // Re-enable button
                updateBtn.disabled = false;
                updateBtn.textContent = 'üîÑ Update Repos';
            }
        }

        // Select repository from dropdown
        function selectRepository() {
            const repositorySelect = document.getElementById('repositorySelect');
            const repositoryInput = document.getElementById('repository_url');
            
            if (repositorySelect.value) {
                repositoryInput.value = repositorySelect.value;
                showStatus(`‚úÖ Selected repository: ${repositorySelect.value}`, 'success');
                
                // Only clear branch dropdown if it's a different repository
                const currentRepo = repositoryInput.value;
                const lastLoadedRepo = localStorage.getItem('lastLoadedRepository');
                
                if (currentRepo !== lastLoadedRepo) {
                    const branchDropdown = document.getElementById('branchDropdown');
                    const branchSelect = document.getElementById('branchSelect');
                    branchDropdown.style.display = 'none';
                    branchSelect.innerHTML = '<option value="">Select a branch...</option>';
                }
            }
        }

        // Update available branches from GitHub API
        async function updateAvailableBranches() {
            const updateBtn = document.getElementById('updateBranches');
            const branchDropdown = document.getElementById('branchDropdown');
            const branchSelect = document.getElementById('branchSelect');
            const repositoryInput = document.getElementById('repository_url');
            
            if (!repositoryInput.value) {
                showStatus('‚ùå Please select a repository first', 'error');
                return;
            }
            
            try {
                // Disable button and show loading
                updateBtn.disabled = true;
                updateBtn.textContent = 'üîÑ Updating...';
                showStatus('Fetching branches from GitHub API...', 'success');
                
                // Fetch branches from API
                const response = await fetch(`/api/branches?repository_url=${encodeURIComponent(repositoryInput.value)}&force_refresh=true`);
                const data = await response.json();
                
                if (data.branches && data.branches.length > 0) {
                    // Clear existing options
                    branchSelect.innerHTML = '<option value="">Select a branch...</option>';
                    
                    // Add fetched branches
                    data.branches.forEach((branch) => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        branchSelect.appendChild(option);
                    });
                    
                    // Show dropdown
                    branchDropdown.style.display = 'block';
                    
                    // Store data in localStorage for persistence
                    localStorage.setItem('lastLoadedRepository', repositoryInput.value);
                    localStorage.setItem('lastLoadedBranches', JSON.stringify(data.branches));
                    localStorage.setItem('lastBranchLoadTime', Date.now().toString());
                    
                    if (data.success) {
                        showStatus(`‚úÖ Updated! Found ${data.branches.length} branches for ${data.owner}/${data.repo}`, 'success');
                    } else {
                        showStatus(`‚ö†Ô∏è Using fallback branches: ${data.message}`, 'warning');
                    }
                } else {
                    showStatus(`‚ùå No branches available: ${data.message || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Error fetching branches:', error);
                showStatus('‚ùå Failed to fetch branches from GitHub API', 'error');
            } finally {
                // Re-enable button
                updateBtn.disabled = false;
                updateBtn.textContent = 'üîÑ Update Branches';
            }
        }

        // Select branch from dropdown
        function selectBranch() {
            const branchSelect = document.getElementById('branchSelect');
            const branchInput = document.getElementById('branch');
            const createNewBranchCheckbox = document.getElementById('createNewBranch');
            
            if (branchSelect.value) {
                branchInput.value = branchSelect.value;
                createNewBranchCheckbox.checked = false;
                toggleNewBranchInput();
                showStatus(`‚úÖ Selected branch: ${branchSelect.value}`, 'success');
            }
        }

        // Toggle new branch input visibility
        function toggleNewBranchInput() {
            const createNewBranchCheckbox = document.getElementById('createNewBranch');
            const newBranchNameInput = document.getElementById('newBranchName');
            const branchInput = document.getElementById('branch');
            const branchSelect = document.getElementById('branchSelect');
            
            if (createNewBranchCheckbox.checked) {
                newBranchNameInput.style.display = 'block';
                newBranchNameInput.required = true;
                branchSelect.value = '';
                branchInput.value = '';
                newBranchNameInput.focus();
            } else {
                newBranchNameInput.style.display = 'none';
                newBranchNameInput.required = false;
                newBranchNameInput.value = '';
            }
        }

        // Update branch input when new branch name is entered
        function updateBranchFromNewName() {
            const newBranchNameInput = document.getElementById('newBranchName');
            const branchInput = document.getElementById('branch');
            const createNewBranchCheckbox = document.getElementById('createNewBranch');
            
            if (createNewBranchCheckbox.checked && newBranchNameInput.value) {
                branchInput.value = newBranchNameInput.value;
            }
        }

        // Handle form submission
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const config = Object.fromEntries(formData.entries());
            
            try {
                // Show loading state
                showStatus('Creating background agent...', 'success');
                
                // In a real implementation, this would call the MCP server
                const agentConfig = {
                    repository_url: config.repository_url,
                    prompt: config.prompt,
                    branch: config.branch,
                    model: config.model
                };

                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Save config to localStorage
                localStorage.setItem('cursorAgentConfig', JSON.stringify(agentConfig));
                
                // Show success message
                showStatus(`‚úÖ Configuration saved! Agent would be created for ${config.repository_url}`, 'success');
                
                // In a real implementation, you would:
                // 1. Call the MCP server API
                // 2. Start the background agent
                // 3. Show real-time progress
                
                console.log('Agent Configuration:', agentConfig);
                
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        });

        // Load saved config on page load
        window.addEventListener('load', function() {
            const savedConfig = localStorage.getItem('cursorAgentConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    
                    document.getElementById('repository_url').value = config.repository_url || '';
                    document.getElementById('prompt').value = config.prompt || '';
                    document.getElementById('branch').value = config.branch || 'main';
                    document.getElementById('model').value = config.model || 'claude-4-sonnet-thinking';
                    
                    // Trigger model info update
                    updateModelInfo();
                    
                } catch (e) {
                    console.error('Error loading saved config:', e);
                }
            }
        });

        // Restore model data from localStorage
        function restoreModelData() {
            const modelSelect = document.getElementById('model');
            const lastLoadedModels = localStorage.getItem('lastLoadedModels');
            const lastLoadTime = localStorage.getItem('lastModelLoadTime');
            
            // Check if we have cached data and it's not too old (5 minutes)
            if (lastLoadedModels && lastLoadTime) {
                const cacheAge = Date.now() - parseInt(lastLoadTime);
                const maxCacheAge = 5 * 60 * 1000; // 5 minutes
                
                if (cacheAge < maxCacheAge) {
                    try {
                        const models = JSON.parse(lastLoadedModels);
                        
                        // Clear existing options
                        modelSelect.innerHTML = '';
                        
                        // Add cached models
                        models.forEach((model) => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = formatModelName(model);
                            modelSelect.appendChild(option);
                        });
                        
                        // Restore previous selection if available
                        const savedModel = localStorage.getItem('selectedModel');
                        if (savedModel && models.includes(savedModel)) {
                            modelSelect.value = savedModel;
                        }
                        
                        updateModelInfo();
                        showStatus(`‚úÖ Restored ${models.length} cached models`, 'success');
                    } catch (e) {
                        console.error('Error parsing cached model data:', e);
                    }
                }
            }
        }

        // Restore repository data from localStorage
        function restoreRepositoryData() {
            const repositoryDropdown = document.getElementById('repositoryDropdown');
            const repositorySelect = document.getElementById('repositorySelect');
            const lastLoadedRepositories = localStorage.getItem('lastLoadedRepositories');
            const lastLoadTime = localStorage.getItem('lastRepositoryLoadTime');
            
            // Check if we have cached data and it's not too old (5 minutes)
            if (lastLoadedRepositories && lastLoadTime) {
                const cacheAge = Date.now() - parseInt(lastLoadTime);
                const maxCacheAge = 5 * 60 * 1000; // 5 minutes
                
                if (cacheAge < maxCacheAge) {
                    try {
                        const repositories = JSON.parse(lastLoadedRepositories);
                        
                        // Clear existing options
                        repositorySelect.innerHTML = '<option value="">Select a repository...</option>';
                        
                        // Add cached repositories
                        repositories.forEach((repo) => {
                            const option = document.createElement('option');
                            option.value = repo.repository;
                            option.textContent = `${repo.owner}/${repo.name}`;
                            repositorySelect.appendChild(option);
                        });
                        
                        // Show dropdown
                        repositoryDropdown.style.display = 'block';
                        
                        showStatus(`‚úÖ Restored ${repositories.length} cached repositories`, 'success');
                    } catch (e) {
                        console.error('Error parsing cached repository data:', e);
                    }
                }
            }
        }

        // Restore branch data from localStorage
        function restoreBranchData() {
            const repositoryInput = document.getElementById('repository_url');
            const branchDropdown = document.getElementById('branchDropdown');
            const branchSelect = document.getElementById('branchSelect');
            
            const lastLoadedRepo = localStorage.getItem('lastLoadedRepository');
            const lastLoadedBranches = localStorage.getItem('lastLoadedBranches');
            const lastLoadTime = localStorage.getItem('lastBranchLoadTime');
            
            // Check if we have cached data and it's not too old (5 minutes)
            if (lastLoadedRepo && lastLoadedBranches && lastLoadTime) {
                const cacheAge = Date.now() - parseInt(lastLoadTime);
                const maxCacheAge = 5 * 60 * 1000; // 5 minutes
                
                if (cacheAge < maxCacheAge) {
                    // Restore branches if repository matches (or if no repository is set yet)
                    if (repositoryInput.value === lastLoadedRepo || !repositoryInput.value) {
                        try {
                            const branches = JSON.parse(lastLoadedBranches);
                            
                            // Clear existing options
                            branchSelect.innerHTML = '<option value="">Select a branch...</option>';
                            
                            // Add cached branches
                            branches.forEach((branch) => {
                                const option = document.createElement('option');
                                option.value = branch;
                                option.textContent = branch;
                                branchSelect.appendChild(option);
                            });
                            
                            // Show dropdown
                            branchDropdown.style.display = 'block';
                            
                            // Set the repository input if it's empty
                            if (!repositoryInput.value) {
                                repositoryInput.value = lastLoadedRepo;
                            }
                            
                            showStatus(`‚úÖ Restored ${branches.length} cached branches for ${lastLoadedRepo}`, 'success');
                        } catch (e) {
                            console.error('Error parsing cached branch data:', e);
                        }
                    }
                }
            }
        }

        // Add event listener for model selection change
        document.getElementById('model').addEventListener('change', updateModelInfo);
        
        // Initialize model info on page load
        updateModelInfo();
        
        // Restore all cached data on page load
        restoreModelData();
        restoreRepositoryData();
        restoreBranchData();
        
        // Load agents on page load since manage view is default
        loadAgents();
    </script>
</body>
</html>
